// If Web Animations API isn't available or fails, don't get stuck.
try {
  if (typeof cloneA.animate !== "function" || typeof cloneB.animate !== "function") {
    throw new Error("No Web Animations API");
  }

  const animA = cloneA.animate([
    { transform: "translate(0px, 0px)" },
    { transform: `translate(${dxA/2 + arc}px, ${dyA/2}px)` },
    { transform: `translate(${dxA}px, ${dyA}px)` },
  ], {
    duration: 360,
    easing: "cubic-bezier(.2,8,2,1)",
    fill: "forwards",
  });

  const animB = cloneB.animate([
    { transform: "translate(0px, 0px)" },
    { transform: `translate(${dxB/2 - arc}px, ${dyB/2}px)` },
    { transform: `translate(${dxB}px, ${dyB}px)` },
  ], {
    duration: 360,
    easing: "cubic-bezier(.2,8,2,1)",
    fill: "forwards",
  });

  Promise.all([animA.finished, animB.finished]).then(() => {
    try { cloneA.remove(); } catch(e){}
    try { cloneB.remove(); } catch(e){}

    if (newChipA) newChipA.classList.remove("swap-hidden");
    if (newChipB) newChipB.classList.remove("swap-hidden");

    st._swapAnimating = false;
  }).catch(() => {
    // safety cleanup if animation is interrupted
    try { cloneA.remove(); } catch(e){}
    try { cloneB.remove(); } catch(e){}
    if (newChipA) newChipA.classList.remove("swap-hidden");
    if (newChipB) newChipB.classList.remove("swap-hidden");
    st._swapAnimating = false;
  });

} catch (e) {
  // Fallback: no animation, but NEVER leave clones behind or lock swapping
  try { cloneA.remove(); } catch(err){}
  try { cloneB.remove(); } catch(err){}
  if (newChipA) newChipA.classList.remove("swap-hidden");
  if (newChipB) newChipB.classList.remove("swap-hidden");
  st._swapAnimating = false;
}
